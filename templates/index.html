{% extends "base.html" %}

{% block title %}Substack Reader{% endblock %}

{% block content %}
    <h1>Enter a Substack Feed</h1>
    <p>Enter a Substack name (e.g., "writebuildscale") or a full URL to view its RSS feed.</p>

    {% if error %}
        <div class="alert">{{ error }}</div>
    {% endif %}

    <!-- Add id="feed-form" to the form -->
    <form id="feed-form" action="{{ url_for('view_feed') }}" method="post" style="display: flex; gap: 10px; margin-bottom: 1rem;">
        <input type="text" name="feed_input" value="{{ last or '' }}" placeholder="e.g., packy" required style="flex-grow: 1;">
        <!-- Add id="submit-button" to the button -->
        <button id="submit-button" type="submit" class="btn" style="border: 1px solid var(--link-color); color: var(--link-color);">View Feed</button>
    </form>
    <div id="history-container" style="display: none; margin-bottom: 2.5rem;">
    <h3>Recently Viewed</h3>
    <ul id="history-list" class="history-list"></ul>
</div>
    <!-- Loading indicator, hidden by default -->
    <div id="loading-spinner" style="display: none; text-align: center; padding: 1rem;">
        <span>Fetching feed...</span>
    </div>

    <div class="demonstration" style="margin-top: 2.5rem;">
        <h2 style="text-align: center; margin-bottom: 1rem;">How it Works</h2>
        <img src="{{ url_for('static', filename='demo-gif.gif') }}" 
             alt="Demonstration of entering a feed name and downloading a file" 
             style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border-color);">
    </div>

    <!-- Add this script at the bottom of the block -->
    <script>
        document.getElementById('feed-form').addEventListener('submit', function() {
            // Disable the button to prevent multiple submissions
            document.getElementById('submit-button').disabled = true;
            document.getElementById('submit-button').textContent = 'Loading...';
            
            // Show the spinner
            document.getElementById('loading-spinner').style.display = 'block';
        });
    // This script runs when the index page loads
    const historyList = document.getElementById('history-list');
    const historyContainer = document.getElementById('history-container');
    const history = JSON.parse(localStorage.getItem('feedHistory')) || [];

    if (history.length > 0) {
        historyContainer.style.display = 'block';
        history.forEach(item => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = `${item.title} (${item.url})`;
            link.onclick = function(e) {
                e.preventDefault();
                // When clicked, fill the form and submit it
                document.querySelector('input[name="feed_input"]').value = item.url;
                document.getElementById('feed-form').submit();
            };
            listItem.appendChild(link);
            historyList.appendChild(listItem);
        });
    }

    </script>
{% endblock %}